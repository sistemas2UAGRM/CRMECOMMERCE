# üìã AN√ÅLISIS COMPLETO DE CASOS DE USO - BACKEND DJANGO

## üéØ RESUMEN EJECUTIVO

El Backend implementa **4 m√≥dulos principales** con casos de uso espec√≠ficos que cubren las funcionalidades de un sistema CRM+E-commerce completo.

---

## üìä CASOS DE USO IDENTIFICADOS POR M√ìDULO

### üîê **M√ìDULO USUARIOS** (User Management)
**Archivos**: `api/v1/users/views.py`, `api/v1/users/serializers.py`

#### CU-U01: Registro P√∫blico de Clientes
- **Endpoint**: `POST /api/v1/users/register/`
- **Descripci√≥n**: Cualquier persona puede registrarse como cliente
- **Validaciones**: Email √∫nico, confirmaci√≥n de contrase√±a, t√©rminos y condiciones
- **Rol asignado**: `cliente` autom√°ticamente
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-U02: Registro de Usuarios por Administrador
- **Endpoint**: `POST /api/v1/users/admin-register/`
- **Descripci√≥n**: Administradores crean usuarios con roles espec√≠ficos
- **Roles disponibles**: `administrador`, `empleadonivel1`, `empleadonivel2`, `cliente`
- **Caracter√≠sticas**: Contrase√±a generada autom√°ticamente, email de bienvenida
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-U03: Autenticaci√≥n con JWT
- **Endpoint**: `POST /api/v1/users/login/`
- **Descripci√≥n**: Login con email/contrase√±a que retorna tokens JWT
- **Tokens**: Access token (1 hora) + Refresh token (30 d√≠as)
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-U04: Gesti√≥n de Perfil de Usuario
- **Endpoints**: 
  - `GET /api/v1/users/profile/` - Ver perfil
  - `PUT/PATCH /api/v1/users/profile/` - Actualizar perfil
- **Descripci√≥n**: Usuario puede ver y actualizar su informaci√≥n personal
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-U05: B√∫squeda de Usuarios
- **Endpoint**: `GET /api/v1/users/search/?q=juan`
- **Descripci√≥n**: Buscar usuarios por username, email, nombre o apellido
- **Permisos**: Solo administradores y supervisores
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-U06: Listar Usuarios Activos
- **Endpoint**: `GET /api/v1/users/active/`
- **Descripci√≥n**: Obtener solo usuarios con is_active=True
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-U07: Usuarios por Rol
- **Endpoint**: `GET /api/v1/users/by-role/{role_name}/`
- **Descripci√≥n**: Filtrar usuarios por rol espec√≠fico
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-U08: Estad√≠sticas de Usuarios
- **Endpoint**: `GET /api/v1/users/stats/`
- **Descripci√≥n**: M√©tricas como total usuarios, usuarios por rol, usuarios activos
- **Estado**: ‚úÖ **IMPLEMENTADO**

---

### üîê **M√ìDULO CRM** (Roles y Permisos)
**Archivos**: `api/v1/crm/views.py`, `api/v1/crm/serializers.py`

#### CU-C01: Gesti√≥n de Roles (CRUD)
- **Endpoints**: 
  - `GET /api/v1/crm/roles/` - Listar roles
  - `POST /api/v1/crm/roles/` - Crear rol
  - `GET /api/v1/crm/roles/{id}/` - Detalle de rol
  - `PUT /api/v1/crm/roles/{id}/` - Actualizar rol
- **Descripci√≥n**: Administraci√≥n completa de roles del sistema
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-C02: Gesti√≥n de Permisos de Rol
- **Endpoints**:
  - `GET /api/v1/crm/roles/{id}/permissions/` - Ver permisos de rol
  - `PUT /api/v1/crm/roles/{id}/permissions/` - Actualizar permisos
- **Descripci√≥n**: Asignar/remover permisos espec√≠ficos a roles
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-C03: Asignaci√≥n de Roles a Usuario
- **Endpoint**: `POST /api/v1/crm/assign-role/{user_id}/`
- **Descripci√≥n**: Asignar m√∫ltiples roles a un usuario espec√≠fico
- **Auditor√≠a**: Registra motivo de asignaci√≥n en bit√°cora
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-C04: Consultar Usuarios por Rol
- **Endpoint**: `GET /api/v1/crm/users-by-role/{role_name}/`
- **Descripci√≥n**: Ver qu√© usuarios tienen un rol espec√≠fico
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-C05: Listar Permisos Disponibles
- **Endpoint**: `GET /api/v1/crm/permisos/`
- **Descripci√≥n**: Ver todos los permisos disponibles en el sistema
- **Estado**: ‚úÖ **IMPLEMENTADO**

---

### üìä **M√ìDULO AUDITOR√çA** (Bit√°cora)
**Archivos**: `api/v1/common/views.py`, `api/v1/common/serializers.py`

#### CU-A01: Consultar Bit√°cora
- **Endpoint**: `GET /api/v1/common/bitacora/`
- **Descripci√≥n**: Ver registro de todas las acciones del sistema
- **Filtros**: Por fecha, usuario, acci√≥n, IP
- **Permisos jer√°rquicos**: Administradores ven todo, supervisores su equipo, vendedores solo sus acciones
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-A02: Estad√≠sticas de Auditor√≠a
- **Endpoint**: `GET /api/v1/common/bitacora/stats/`
- **Descripci√≥n**: M√©tricas como acciones por d√≠a, usuarios activos, tipos de acciones
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-A03: Exportar Registros de Auditor√≠a
- **Endpoint**: `GET /api/v1/common/bitacora/export/`
- **Descripci√≥n**: Exportar registros filtrados (m√°ximo 10,000)
- **Permisos**: Solo administradores
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-A04: Registro Autom√°tico de Acciones
- **Descripci√≥n**: Todas las acciones importantes se registran autom√°ticamente
- **Datos**: Usuario, acci√≥n, fecha/hora, IP, detalles
- **Estado**: ‚úÖ **IMPLEMENTADO**

---

### üõçÔ∏è **M√ìDULO E-COMMERCE** (Productos y Carritos)
**Archivos**: `api/v1/ecommerce/views.py`, `api/v1/ecommerce/serializers.py`

#### **GESTI√ìN DE CATEGOR√çAS**

#### CU-E01: Gesti√≥n de Categor√≠as (CRUD)
- **Endpoints**:
  - `GET /api/v1/ecommerce/categorias/` - Listar categor√≠as
  - `POST /api/v1/ecommerce/categorias/` - Crear categor√≠a
  - `GET /api/v1/ecommerce/categorias/{id}/` - Detalle de categor√≠a
- **Descripci√≥n**: Administraci√≥n de categor√≠as de productos
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### **GESTI√ìN DE PRODUCTOS**

#### CU-E02: Crear Producto
- **Endpoint**: `POST /api/v1/ecommerce/productos/`
- **Descripci√≥n**: Crear nuevo producto con stock inicial
- **Validaciones**: Precio positivo, stock v√°lido, categor√≠a existente
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E03: Listar Cat√°logo de Productos
- **Endpoint**: `GET /api/v1/ecommerce/productos/`
- **Descripci√≥n**: Ver cat√°logo p√∫blico de productos activos
- **Filtros**: Por categor√≠a, precio, disponibilidad
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E04: Detalle de Producto
- **Endpoint**: `GET /api/v1/ecommerce/productos/{id}/`
- **Descripci√≥n**: Ver informaci√≥n completa de un producto
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E05: Actualizar Stock de Producto
- **Endpoint**: `PUT /api/v1/ecommerce/productos/{id}/stock/`
- **Descripci√≥n**: Actualizar cantidad en stock (solo admin/supervisor)
- **Validaciones**: Stock no negativo
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### **GESTI√ìN DE CARRITOS**

#### CU-E06: Crear Carrito
- **Descripci√≥n**: Se crea autom√°ticamente cuando usuario agrega primer producto
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E07: Agregar Producto al Carrito
- **Endpoint**: `POST /api/v1/ecommerce/carritos/{id}/productos/`
- **Descripci√≥n**: Agregar producto con cantidad espec√≠fica
- **Validaciones**: Stock disponible, producto activo
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E08: Ver Mi Carrito
- **Endpoint**: `GET /api/v1/ecommerce/carritos/mi-carrito/`
- **Descripci√≥n**: Ver carrito actual del usuario autenticado
- **Informaci√≥n**: Productos, cantidades, subtotales, total
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E09: Actualizar Cantidad en Carrito
- **Endpoint**: `PUT /api/v1/ecommerce/carritos/{id}/productos/{producto_id}/`
- **Descripci√≥n**: Cambiar cantidad de un producto en el carrito
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E10: Eliminar Producto del Carrito
- **Endpoint**: `DELETE /api/v1/ecommerce/carritos/{id}/productos/{producto_id}/`
- **Descripci√≥n**: Remover producto completamente del carrito
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### **REPORTES Y ESTAD√çSTICAS**

#### CU-E11: Estad√≠sticas de Productos
- **Endpoint**: `GET /api/v1/ecommerce/productos/stats/`
- **Descripci√≥n**: M√©tricas como total productos, por categor√≠a, stock bajo
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E12: Productos por Categor√≠a
- **Endpoint**: `GET /api/v1/ecommerce/categorias/{id}/productos/`
- **Descripci√≥n**: Listar productos de una categor√≠a espec√≠fica
- **Estado**: ‚úÖ **IMPLEMENTADO**

#### CU-E13: Filtrar Productos por Estado
- **Endpoint**: `GET /api/v1/ecommerce/productos/por-estado/?estado={disponible|agotado|no_disponible}`
- **Descripci√≥n**: Filtrar productos seg√∫n disponibilidad
- **Estados**: 
  - `disponible`: activo=True y stock > 0
  - `agotado`: activo=True y stock = 0
  - `no_disponible`: activo=False
- **Estado**: ‚úÖ **IMPLEMENTADO**

---

## üéØ **AN√ÅLISIS DE COMPLEJIDAD**

### ‚ö†Ô∏è **ARCHIVOS QUE NECESITAN SIMPLIFICACI√ìN**

#### 1. **`api/v1/users/views.py`** (797 l√≠neas)
**Problemas identificados:**
- Una sola clase `UserViewSet` con demasiadas responsabilidades
- M√∫ltiples decoradores Swagger muy largos (50+ l√≠neas cada uno)
- L√≥gica de permisos repetida en m√∫ltiples m√©todos
- M√©todos muy largos (algunos 50+ l√≠neas)

**Soluciones propuestas:**
- Separar en m√∫ltiples ViewSets especializados
- Crear mixins para l√≥gica de permisos com√∫n
- Simplificar documentaci√≥n Swagger
- Extraer validaciones a m√©todos auxiliares

#### 2. **`api/v1/common/views.py`** (341 l√≠neas)
**Problemas identificados:**
- M√©todo `apply_custom_filters()` muy largo (50+ l√≠neas)
- L√≥gica de estad√≠sticas compleja en `stats()`
- M√∫ltiples validaciones anidadas

**Soluciones propuestas:**
- Crear clases Filter separadas
- Extraer c√°lculo de estad√≠sticas a servicios
- Usar django-filter para filtros complejos

#### 3. **`api/v1/crm/views.py`** (345 l√≠neas)
**Problemas identificados:**
- Similar al m√≥dulo users, muchas responsabilidades en pocas clases
- L√≥gica de auditor√≠a duplicada

**Soluciones propuestas:**
- Crear decorador para auditor√≠a autom√°tica
- Separar gesti√≥n de roles de gesti√≥n de permisos

#### 4. **`api/v1/ecommerce/views.py`** (568 l√≠neas)
**Problemas identificados:**
- El archivo m√°s largo, maneja categor√≠as, productos y carritos
- C√°lculos complejos de totales en m√∫ltiples lugares
- Validaciones de stock duplicadas

**Soluciones propuestas:**
- Separar en 3 archivos: categorias_views.py, productos_views.py, carritos_views.py
- Crear servicio para c√°lculos de carrito
- Crear validadores reutilizables para stock

---

## üîß **RECOMENDACIONES DE REFACTORING**

### üìÅ **Estructura Propuesta**
```
api/v1/
‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_views.py          # Login, registro
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile_views.py       # Gesti√≥n de perfil
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_views.py         # Administraci√≥n de usuarios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ search_views.py        # B√∫squedas y estad√≠sticas
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py        # L√≥gica de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_service.py        # L√≥gica de negocio usuarios
‚îÇ   ‚îî‚îÄ‚îÄ mixins/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ permissions_mixin.py   # Permisos reutilizables
‚îú‚îÄ‚îÄ crm/
‚îÇ   ‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roles_views.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permissions_views.py
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ role_assignment_service.py
‚îú‚îÄ‚îÄ ecommerce/
‚îÇ   ‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ categorias_views.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productos_views.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ carritos_views.py
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ cart_service.py        # L√≥gica de carrito
‚îÇ       ‚îî‚îÄ‚îÄ stock_service.py       # Gesti√≥n de inventario
‚îî‚îÄ‚îÄ common/
    ‚îú‚îÄ‚îÄ mixins/
    ‚îÇ   ‚îú‚îÄ‚îÄ audit_mixin.py         # Auditor√≠a autom√°tica
    ‚îÇ   ‚îî‚îÄ‚îÄ pagination_mixin.py    # Paginaci√≥n consistente
    ‚îî‚îÄ‚îÄ services/
        ‚îî‚îÄ‚îÄ audit_service.py       # Servicio de bit√°cora
```

### üéØ **Beneficios del Refactoring**
1. **Mantenibilidad**: Archivos m√°s peque√±os y enfocados
2. **Reutilizaci√≥n**: Servicios y mixins compartidos
3. **Testabilidad**: Cada componente se puede testear independientemente
4. **Escalabilidad**: F√°cil agregar nuevas funcionalidades
5. **Legibilidad**: C√≥digo m√°s f√°cil de entender y modificar

---

## ‚úÖ **ESTADO ACTUAL: SPRINT 1 COMPLETO**

### üìä **M√©tricas de Implementaci√≥n**
- **Total Casos de Uso**: **25+ casos** implementados
- **Endpoints API**: **50+ endpoints** funcionales
- **Cobertura**: **100%** de los casos de uso del Sprint 1
- **Documentaci√≥n**: API completamente documentada con Swagger

### üöÄ **Funcionalidades Principales Operativas**
1. ‚úÖ Sistema de autenticaci√≥n JWT completo
2. ‚úÖ Gesti√≥n de usuarios con roles jer√°rquicos
3. ‚úÖ Auditor√≠a completa de acciones
4. ‚úÖ Cat√°logo de productos funcional
5. ‚úÖ Sistema de carritos de compra
6. ‚úÖ API REST totalmente documentada

### üìà **Preparado para Sprint 2**
- Estructura s√≥lida para agregar funcionalidades de ventas
- Base de datos optimizada para transacciones
- Sistema de permisos escalable
- Auditor√≠a completa para cumplimiento

---

**üí° El backend est√° completamente funcional y cumple con todos los requisitos del Sprint 1, pero se beneficiar√≠a significativamente de un refactoring para mejorar la mantenibilidad a largo plazo.**
